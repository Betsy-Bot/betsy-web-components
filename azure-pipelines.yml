# Docker
# Build and push an image to Azure Container Registry
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
    - master

resources:
    - repo: self

variables:
    # Container registry service connection established during pipeline creation
    dockerRegistryServiceConnection: '4d99b72f-99af-4aa6-9be8-c6f43af4d429'
    imageRepository: 'betsypanelqa'
    containerRegistry: 'BetsyContainerRegistry'
    dockerfilePath: '**/Dockerfile'
    tag: '$(Build.BuildId)'

    # Agent VM image name
    vmImageName: 'ubuntu-latest'

stages:
    - stage: Build_And_Deploy
      displayName: Build and Push Docker Image
      jobs:
          - job: Npm_Install
            displayName: Run NPM Install
            pool:
                vmImage: $(vmImageName)
            steps:
                - task: Bash@3
                  displayName: Run npm i
                  inputs:
                      targetType: 'inline'
                      script: 'npm i'
                - task: Bash@3
                  displayName: Run npm run build:staging
                  inputs:
                      targetType: 'inline'
                      script: 'npm run build:staging'
                - task: Docker@2
                  inputs:
                        containerRegistry: 'BetsyContainerRegistry'
                        repository: 'BestyPanel'
                        command: 'buildAndPush'
                        Dockerfile: '**/Dockerfile'
