<template>
    <confirmation-dialog
        cancel-text="Cancel"
        confirm-text="Delete"
        dialog.two-way="confirmDeleteDialog"
        handler.call="deletePoll(event)"
        title="Are you sure you would like to delete?"
    >
        This is a permanent action and cannot be undone
    </confirmation-dialog>

    <section id="create-data-command">
        <div class="row">
            <div class="col-12 col-lg-8">
                <discord-feature-header
                    doc-url="https://docs.betsybot.xyz/features/polls"
                    title="${isNew ? 'Create' : 'Edit'} Poll"
                    subtitle="Polls will keep a record of the results here for your convenience."
                ></discord-feature-header>
                <div class="text-end my-4">
                    <button mdc-button class="button-secondary" click.delegate="confirmDeleteDialog.open()">
                        Delete Poll
                    </button>
                </div>
                <button
                    class="mt-3"
                    mdc-switch
                    selected.bind="poll.active"
                    value.bind="poll.active"
                    change.delegate="poll.active = !!poll.active"
                ></button>
                <label class="me-5 mb-3">Active?</label>

                <mdc-tab-bar view-model.ref="tabBar">
                    <mdc-tab
                        label="Settings"
                        active.bind="tab === 'settings'"
                        click.delegate="tab = 'settings'"
                    ></mdc-tab>
                    <mdc-tab
                        label="Container"
                        active.bind="tab === 'container'"
                        click.delegate="tab = 'container'"
                    ></mdc-tab>
                    <mdc-tab
                        label="Options"
                        active.bind="tab === 'options'"
                        click.delegate="tab = 'options'"
                    ></mdc-tab>
                </mdc-tab-bar>

                <form submit.delegate="save()">
                    <div if.bind="tab === 'settings'">
                        <mdc-text-field
                            label="Name"
                            type="text"
                            class="w-100 my-2"
                            value.bind="poll.name"
                            required
                        ></mdc-text-field>
<!--                        <div class="my-2">-->
<!--                            <date-time-picker-->
<!--                                label="End Date Time"-->
<!--                                value.two-way="poll.ends"-->
<!--                            ></date-time-picker>-->
<!--                        </div>-->
                        <div class="mt-3 mb-2">
                            <discord-channel-selector
                                required.bind="true"
                                label="Channel"
                                channel-id.two-way="poll.discordChannelId"
                            ></discord-channel-selector>
                        </div>
                        <div class="text-end">
                            <button mdc-button class="button-primary" click.delegate="tab = 'container'" type="button">
                                Next
                            </button>
                        </div>
                    </div>
                    <div class="" if.bind="tab === 'container'">
                        <discord-message-creator
                            allow-components="true"
                            message.two-way="poll.containerMessage.message"
                        ></discord-message-creator>

                        <div class="text-end mt-3">
                            <button type="button" mdc-button class="button-primary" click.delegate="tab = 'options'">
                                Next
                            </button>
                        </div>
                    </div>
                    <div class="" if.bind="tab === 'options'">
                        <mdc-text-field
                            label="Select Menu Label"
                            type="text"
                            class="w-100 my-2"
                            value.bind="poll.containerMessage.message.components[0].components[0].label"
                            required
                        ></mdc-text-field>

                        <div class="p-3" mdc-elevation="9">
                            <mdc-text-field
                                class="w-100 my-2"
                                label="Option Label"
                                value.bind="option.label"
                            ></mdc-text-field>
                            <mdc-text-field
                                class="w-100 my-2"
                                label="Option Description"
                                value.bind="option.description"
                            ></mdc-text-field>
                            <discord-emoji-selector
                                value.two-way="option.emoji"
                                size.bind="100"
                                label="Emoji"
                            ></discord-emoji-selector>

                            <div class="my-3">
                                <button type="button" mdc-button class="button-primary" click.delegate="addOption()">
                                    Add Option
                                </button>
                            </div>
                        </div>

                        <div class="options my-3">
                            <h5>Options:</h5>
                            <div class="row">
                                <div class="my-3 col-6" repeat.for="option of poll.containerMessage.message.components[0].components[0].options">
                                    <div class="p-2" mdc-elevation="9">
                                        <div>Label: ${option.label}</div>
                                        <div>Description: ${option.description}</div>
                                        <div>Emoji: <img src="https://cdn.discordapp.com/emojis/${option.emoji.id}.webp?size=24&quality=lossless"> ${option.emoji.name}</div>
                                        <button type="button" mdc-button class="button-primary" click.delegate="removeOption($index)">
                                            Delete Option
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="text-end mt-3">
                            <button type="submit" mdc-button class="button-primary">
                                Safe
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="col-12 col-lg-4">
                <discord-message-preview message.two-way="poll.containerMessage.message"></discord-message-preview>
            </div>
        </div>
        <div class="py-5" if.bind="poll.participants">
            <h4>Totals</h4>
            <div class="my-3">
                <div repeat.for="answer of answers">
                    ${answer.answer} (${answer.count})
                </div>
            </div>
            <h4>Participants</h4>
            <dx-data-grid items.bind="poll.participants"></dx-data-grid>
        </div>
    </section>
</template>
